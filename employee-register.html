<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>맛남살롱 직원 가입</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --primary-color: #8b7355; 
      --primary-dark: #6b5d4f; 
      --bg-light: #f5f1e8; 
      --bg-white: #fdfcfa;
      --text-primary: #6b5d4f; 
      --text-secondary: #9b8a76; 
      --border-color: #e8dfd0; 
      --border-radius: 8px;
      --shadow-sm: 0 2px 8px rgba(107, 93, 79, 0.08); 
      --shadow-lg: 0 8px 24px rgba(107, 93, 79, 0.15);
      --spacing-xs: 6px; 
      --spacing-sm: 12px; 
      --spacing-md: 16px; 
      --spacing-lg: 24px; 
      --spacing-xl: 32px;
      --success-color: #7a9b7a; 
      --warning-color: #d4a574; 
      --danger-color: #c67b7b;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Apple SD Gothic Neo', 'Malgun Gothic', sans-serif;
      background: var(--bg-light);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      color: var(--text-primary);
    }

    .register-box {
      background: var(--bg-white);
      border-radius: 12px;
      padding: 48px 40px;
      box-shadow: var(--shadow-lg);
      max-width: 500px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      border: 1px solid var(--border-color);
    }

    .logo {
      text-align: center;
      font-size: 64px;
      margin-bottom: 16px;
    }

    h1 {
      text-align: center;
      font-size: 28px;
      color: var(--text-primary);
      margin-bottom: 8px;
      font-weight: 700;
    }

    .subtitle {
      text-align: center;
      color: var(--text-secondary);
      margin-bottom: 32px;
      font-size: 14px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--text-primary);
      font-size: 14px;
    }

    label .required {
      color: var(--danger-color);
    }

    input, select {
      width: 100%;
      padding: 14px 16px;
      border: 2px solid var(--border-color);
      border-radius: var(--border-radius);
      font-size: 15px;
      transition: all 0.2s;
      background: var(--bg-white);
      color: var(--text-primary);
    }

    input:focus, select:focus {
      border-color: var(--primary-color);
      outline: none;
    }

    .btn {
      width: 100%;
      padding: 14px;
      background: var(--primary-color);
      color: var(--bg-white);
      border: none;
      border-radius: var(--border-radius);
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      margin-top: 10px;
    }

    .btn:hover {
      background: var(--primary-dark);
      box-shadow: var(--shadow-sm);
    }

    .btn:disabled {
      background: var(--text-secondary);
      cursor: not-allowed;
      opacity: 0.6;
    }

    .error {
      background: #f5e3e3;
      color: #8b5555;
      padding: 12px;
      border-radius: var(--border-radius);
      margin-bottom: 20px;
      font-size: 14px;
      border: 1px solid #e8c0c0;
      display: none;
    }

    .error.show {
      display: block;
    }

    .success {
      background: #e6f2e6;
      color: #4a6b4a;
      padding: 12px;
      border-radius: var(--border-radius);
      margin-bottom: 20px;
      font-size: 14px;
      border: 1px solid #c0dcc0;
      display: none;
    }

    .success.show {
      display: block;
    }

    .loading {
      display: none;
      text-align: center;
      color: var(--primary-color);
      font-weight: 600;
      margin-top: 10px;
    }

    .loading.show {
      display: block;
    }

    .help-text {
      font-size: 12px;
      color: var(--text-secondary);
      margin-top: 4px;
    }

    .login-link {
      text-align: center;
      margin-top: 20px;
      font-size: 14px;
      color: var(--text-secondary);
    }

    .login-link a {
      color: var(--primary-color);
      text-decoration: none;
      font-weight: 600;
    }

    .login-link a:hover {
      text-decoration: underline;
    }

    .section-title {
      font-size: 15px;
      font-weight: 600;
      color: var(--primary-color);
      margin: var(--spacing-lg) 0 var(--spacing-md) 0;
      padding-bottom: var(--spacing-xs);
      border-bottom: 2px solid var(--border-color);
    }
  </style>
</head>
<body>
  <div class="register-box">
    <div class="logo">☕</div>
    <h1>맛남살롱</h1>
    <p class="subtitle">직원 가입</p>

    <div id="error" class="error"></div>
    <div id="success" class="success"></div>

    <form id="registerForm">
      <!-- 기본 정보 -->
      <div class="section-title">👤 기본 정보</div>
      
      <div class="form-group">
        <label for="name">이름 <span class="required">*</span></label>
        <input type="text" id="name" placeholder="김민수" required>
      </div>

      <div class="form-group">
        <label for="birth">주민등록번호 <span class="required">*</span></label>
        <input type="text" id="birth" placeholder="000000-0000000" maxlength="14" required>
        <div class="help-text">- 포함하여 입력해주세요 (인건비 신고용)</div>
      </div>

      <div class="form-group">
        <label for="phone">연락처 <span class="required">*</span></label>
        <input type="tel" id="phone" placeholder="010-1234-5678" required>
        <div class="help-text">- 포함하여 입력해주세요</div>
      </div>

      <div class="form-group">
        <label for="address">주소 <span class="required">*</span></label>
        <input type="text" id="address" placeholder="경기도 부천시 원미구" required>
      </div>

      <!-- 근무 정보 -->
      <div class="section-title">💼 근무 정보</div>
      
      <div class="form-group">
        <label for="store">근무 매장 <span class="required">*</span></label>
        <select id="store" required>
          <option value="">선택하세요</option>
        </select>
      </div>

      <div class="form-group">
        <label for="position">직책/직무 <span class="required">*</span></label>
        <select id="position" required>
          <option value="">선택하세요</option>
          <option value="바리스타">바리스타</option>
          <option value="베이커">베이커</option>
        </select>
      </div>

      <!-- 계정 정보 -->
      <div class="section-title">🔐 계정 정보</div>
      
      <div class="form-group">
        <label for="email">이메일 (로그인 ID) <span class="required">*</span></label>
        <input type="email" id="email" placeholder="example@email.com" required>
        <div class="help-text">로그인 시 사용할 이메일 주소</div>
      </div>

      <div class="form-group">
        <label for="password">비밀번호 <span class="required">*</span></label>
        <input type="password" id="password" placeholder="6자 이상" required minlength="6">
      </div>

      <div class="form-group">
        <label for="passwordConfirm">비밀번호 확인 <span class="required">*</span></label>
        <input type="password" id="passwordConfirm" placeholder="비밀번호 재입력" required minlength="6">
      </div>

      <button type="submit" id="registerBtn" class="btn">가입하기</button>
    </form>

    <div class="loading" id="loading">⏳ 가입 처리 중...</div>

    <div class="login-link">
      이미 계정이 있으신가요? <a href="index.html">메인으로 돌아가기</a>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

  <script>
    // Firebase 설정
    const firebaseConfig = {
      apiKey: "AIzaSyCr3Tq2T7oy5rVlK1c33m_G0TlUWv0-g3k",
      authDomain: "abcdc-staff-system.firebaseapp.com",
      projectId: "abcdc-staff-system",
      storageBucket: "abcdc-staff-system.firebasestorage.app",
      messagingSenderId: "442207878284",
      appId: "1:442207878284:web:49b157573851b124d28fa9",
      measurementId: "G-WYPQ3YEJRT"
    };

    // Firebase 초기화
    const app = firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    console.log('✅ Firebase 초기화 완료');

    // 요소 가져오기
    const registerForm = document.getElementById('registerForm');
    const registerBtn = document.getElementById('registerBtn');
    const loading = document.getElementById('loading');
    const errorDiv = document.getElementById('error');
    const successDiv = document.getElementById('success');

    // 매장 목록 로드
    function loadStores() {
      const storeSelect = document.getElementById('store');
      const stores = JSON.parse(localStorage.getItem('stores') || '[]');
      
      // 기본 매장이 없으면 추가
      if (stores.length === 0) {
        stores.push(
          { id: '1', name: '부천시청점', address: '경기도 부천시 원미구', phone: '032-123-4567' },
          { id: '2', name: '상동점', address: '경기도 부천시 상동', phone: '032-123-4568' },
          { id: '3', name: '부천역사점', address: '경기도 부천시 부천역 인근', phone: '032-123-4569' }
        );
        localStorage.setItem('stores', JSON.stringify(stores));
      }
      
      storeSelect.innerHTML = '<option value="">선택하세요</option>';
      stores.forEach(store => {
        storeSelect.innerHTML += `<option value="${store.name}">${store.name}</option>`;
      });
    }

    // 페이지 로드 시 매장 목록 로드
    loadStores();

    // 에러 표시
    function showError(msg) {
      errorDiv.textContent = msg;
      errorDiv.classList.add('show');
      successDiv.classList.remove('show');
    }

    // 성공 표시
    function showSuccess(msg) {
      successDiv.textContent = msg;
      successDiv.classList.add('show');
      errorDiv.classList.remove('show');
    }

    // 메시지 숨김
    function hideMessages() {
      errorDiv.classList.remove('show');
      successDiv.classList.remove('show');
    }

    // 주민등록번호 자동 포맷팅
    document.getElementById('birth').addEventListener('input', function(e) {
      let value = e.target.value.replace(/[^0-9]/g, ''); // 숫자만 추출
      
      if (value.length > 6) {
        value = value.substring(0, 6) + '-' + value.substring(6, 13);
      }
      
      e.target.value = value;
    });

    // 주민등록번호 유효성 검사
    function validateSSN(ssn) {
      const cleaned = ssn.replace(/-/g, '');
      if (cleaned.length !== 13) {
        return false;
      }
      
      // 숫자만 있는지 확인
      if (!/^\d+$/.test(cleaned)) {
        return false;
      }
      
      return true;
    }

    // 가입 폼 제출
    registerForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const name = document.getElementById('name').value.trim();
      const birth = document.getElementById('birth').value.trim();
      const phone = document.getElementById('phone').value.trim();
      const address = document.getElementById('address').value.trim();
      const store = document.getElementById('store').value;
      const position = document.getElementById('position').value;
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      const passwordConfirm = document.getElementById('passwordConfirm').value;
      
      // 유효성 검사
      if (!name || !birth || !phone || !address || !store || !position || !email || !password) {
        showError('⚠️ 모든 필수 항목을 입력해주세요.');
        return;
      }

      if (!validateSSN(birth)) {
        showError('⚠️ 주민등록번호를 올바르게 입력해주세요. (13자리)');
        return;
      }

      if (password !== passwordConfirm) {
        showError('⚠️ 비밀번호가 일치하지 않습니다.');
        return;
      }

      if (password.length < 6) {
        showError('⚠️ 비밀번호는 최소 6자 이상이어야 합니다.');
        return;
      }
      
      hideMessages();
      registerBtn.disabled = true;
      loading.classList.add('show');
      
      try {
        console.log('📝 직원 가입 시작:', email);
        
        // 1. Firebase Authentication에 사용자 생성
        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
        const user = userCredential.user;
        
        console.log('✅ Auth 사용자 생성 완료:', user.uid);
        
        // 2. Firestore에 직원 정보 저장
        const employeeData = {
          uid: user.uid,
          email: email,
          name: name,
          birth: birth,
          phone: phone,
          address: address,
          store: store,
          position: position,
          userType: 'employee',
          status: 'active',
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        // users 컬렉션에 저장
        await db.collection('users').doc(user.uid).set(employeeData);
        
        // employees 컬렉션에도 저장 (관리자가 쉽게 조회하기 위해)
        await db.collection('employees').doc(user.uid).set(employeeData);
        
        console.log('✅ Firestore에 직원 정보 저장 완료');
        
        showSuccess('✅ 가입이 완료되었습니다! 잠시 후 로그인 페이지로 이동합니다.');
        
        // 3초 후 로그인 페이지로 이동
        setTimeout(() => {
          window.location.href = 'login.html';
        }, 3000);
        
      } catch (error) {
        console.error('❌ 가입 실패:', error);
        
        let errorMsg = '가입에 실패했습니다.';
        
        if (error.code === 'auth/email-already-in-use') {
          errorMsg = '⚠️ 이미 사용 중인 이메일입니다.';
        } else if (error.code === 'auth/invalid-email') {
          errorMsg = '⚠️ 올바른 이메일 주소를 입력하세요.';
        } else if (error.code === 'auth/weak-password') {
          errorMsg = '⚠️ 비밀번호가 너무 약합니다. 6자 이상 입력하세요.';
        } else {
          errorMsg = '❌ ' + (error.message || '가입에 실패했습니다.');
        }
        
        showError(errorMsg);
        registerBtn.disabled = false;
        loading.classList.remove('show');
      }
    });
  </script>
</body>
</html>
